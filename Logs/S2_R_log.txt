
R version 4.4.1 (2024-06-14) -- "Race for Your Life"
Copyright (C) 2024 The R Foundation for Statistical Computing
Platform: x86_64-pc-linux-gnu

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

[Previously saved workspace restored]

> 
> #' ---
> #' title: "Extraction of Barcodes and gene fragments"
> #' author: "Tomas Bjorklund"
> #' edited by: "Jaro Steindorff"
> #' output: barcode_***.fastq.gz, fragments_***.fastq.gz -- fastq.gz files with the paired barcodes and fragments from the given Library.
> #'        This workflow extracts the barcodes and fragments from the sequencing files and saves them as fastq.gz files.
> #' ---
> 
> #  This will make R-functions such as library() and install.packages() use this directory:
> .libPaths(c('~/MyRextensions', .libPaths()))
> 
> suppressPackageStartupMessages(library(ShortRead))
> suppressPackageStartupMessages(library(parallel))
> suppressPackageStartupMessages(library(doParallel))
> suppressPackageStartupMessages(library(data.table))
> suppressPackageStartupMessages(library(devtools))
> suppressPackageStartupMessages(library(Hmisc))
> suppressPackageStartupMessages(library(kableExtra))
> 
> config <- read.table("input/config.txt", header = FALSE, skip = 0, sep="\t",
+                      stringsAsFactors = FALSE, fill=TRUE)
> colnames(config) <- c("Parameter", "Value")
> 
> #'Sequencing files
> #'===================
> # load the data directory and the input files
> dataDir <- config$Value[1]
> in.name.P5 <- file.path(dataDir, config$Value[2])
> in.name.P7 <- file.path(dataDir, config$Value[3])
> name.out <- config$Value[4]
> 
> strt<-Sys.time()
> 
> # Counting reads and displaying the number of reads
> output.Reads <- as.integer(system(paste("gunzip -c ",shQuote(gsub("([\\])", "", in.name.P5)),
+                                               " | echo $((`wc -l`/4)) 2>&1", sep = ""), intern = TRUE, 
+                                         ignore.stdout = FALSE))
> print(paste("Utilized Reads:", output.Reads))
[1] "Utilized Reads: 11595544"
> 
> 
> #' Extraction of barcodes
> #' ============================
> 
> # create a temporary file for the output
> out.name.P5 <- tempfile(pattern = "BC_", tmpdir = tempdir(), fileext = ".fastq.gz")
> 
> # run the bbduk2 command
> sys.out <- system(paste("~/bbmap/bbduk2.sh overwrite=true k=18 mink=18 hammingdistance=2 findbestmatch=t ",
+                         "rcomp=f findbestmatch=f qhdist=1 minavgquality=0 maxns=0 minlength=18 ",
+                         "maxlength=22 threads=", detectCores()," in=", shQuote(in.name.P5), 
+                         " out=", out.name.P5," lliteral=", "GGCCTAGCGGCCGCTTTACTT",
+                         " rliteral=", "ATAACTTCGTATAATGTATGC",
+                         " 2>&1", sep = ""), intern = TRUE, ignore.stdout = FALSE) 
> 
> # set the output as the new input
> in.name.P5 <- out.name.P5
> 
> # remove the output
> rm(sys.out)
> 
> # read the barcodes
> reads.BC <- readFastq(in.name.P5)
> sread(reads.BC)
DNAStringSet object of length 11414787:
           width seq
       [1]    20 GTTGATACAAGGGCAGCAGG
       [2]    20 GTTGGCACACTTGCTCAAGC
       [3]    20 GTGTATTTGAGCGTGTCCGT
       [4]    20 GAGGGCAGACTCGCGGGATC
       [5]    20 GTGTAATGGTACGTGTGTGC
       ...   ... ...
[11414783]    20 CAGGCCTGAATGGCGGGCGG
[11414784]    20 GTTTGCTAGTTCCCGGGTAC
[11414785]    20 CAGGGCGGGTGTGCAGGCGG
[11414786]    20 GTACGTTTCCGTCCATATTG
[11414787]    20 CCTGGTGCGTTGGTGCAAGG
> print(paste("Total number of found barcode reads:", length(reads.BC)))
[1] "Total number of found barcode reads: 11414787"
> 
> 
> #' Extraction of fragments
> #' ============================
> #+ Extracting fragments.......
> 
> # create a temporary file for the output
> out.name.P7 <- tempfile(pattern = "P7_", tmpdir = tempdir(), fileext = ".fastq.gz")
> # run the bbduk2 command
> command.args <- paste("overwrite=true k=18 mink=18 rcomp=f qhdist=1 maskmiddle=t",
+                       " hammingdistance=2 findbestmatch=t minlength=38 maxlength=78 ordered=t ",
+                       "threads=", detectCores(), " in=", in.name.P7, " out=", out.name.P7,
+                       " lliteral=", "AGCAACCTCCAGAGAGGCAACG",
+                       " rliteral=", "CAGACAAGCAGCTACCGCAGAT", sep = "")
> 
> sys.out <- system2(path.expand("~/bbmap/bbduk2.sh"), args=command.args, stdout=TRUE, stderr=TRUE) 
> 
> # remove the output
> rm(sys.out)
> 
> # set the input as the output
> in.name.P7 <- out.name.P7
> 
> # read the fragments
> reads.Frag <- readFastq(in.name.P7)
> sread(reads.Frag)
DNAStringSet object of length 10856003:
           width seq
       [1]    46 CTGGCGGCACCTTCACCGGCACCTTCACCCCCGACAACAACCAGGC
       [2]    70 GAGGCGGAGGAAGTGCCACCAACAACGCCC...GGACAACAGCTACCCCGGAGGCGGCGGAAG
       [3]    46 CTTACGGCGACCTGCTGTACAACGGCGCCTACCACCTGAACGGCGC
       [4]    54 CTAGGCACAAGAGCGGCACAGCATCGGCAACGCCTCACCTGCGATCTCGATGGT
       [5]    46 CTGTGCTGCGCTGGCGCTTCGCCCGCACCCTGCCCCACGCCCGCGC
       ...   ... ...
[10855999]    70 CTGTCACCAACCACGTGGCCACCGAGCGGC...GGCCGAGACCAGCGCCCGCATCAGCACCGC
[10856000]    70 GAGGCGGAGGAAGCCGGGGCCTCGACAGCA...CAGCTACTGCACCACCGGAGGCGGCGGAAG
[10856001]    68 CTAGCGTGACCACGACGCCGTGGAGGCCGC...ACCCGCCGACGCGGCAGCCCCCGCCGCCGC
[10856002]    70 CTGCCAGCCCCGGCCTGCTGGAGCTGTGCG...CTTCGAGCGGGTGCTGGCCTTCCTGATCGC
[10856003]    46 CTAACCGGTTCCACTGCCACTTCAGCCCCCGGGACTGGCAGCGGGC
> print(paste("Total number of found fragment reads:", length(reads.Frag)))
[1] "Total number of found fragment reads: 10856003"
> 
> # create a temporary file for the output of the fragments and barcodes 
> out.name.P5 <- tempfile(pattern = "P5_", tmpdir = tempdir(), fileext = ".fastq.gz")
> out.name.P7 <- tempfile(pattern = "P7_", tmpdir = tempdir(), fileext = ".fastq.gz")
> out.name.P5_singlet <- tempfile(pattern = "P5_singlet_", tmpdir = tempdir(), fileext = ".fastq.gz")
> out.name.P7_singlet <- tempfile(pattern = "P7_singlet_", tmpdir = tempdir(), fileext = ".fastq.gz")
> 
> # run the pairfq command to pair the barcodes and fragments
> command.args <- paste("makepairs -c 'gzip' -f ", in.name.P5," -r ", in.name.P7,
+                       " -fp ", out.name.P5, " -rp ", out.name.P7, " -fs ",
+                       out.name.P5_singlet, " -rs ", out.name.P7_singlet,
+                       " --stats 2>&1", sep = "")
> 
> sys.out <- system2("pairfq", args=command.args, stdout=TRUE, stderr=TRUE)
> 
> # save the barcodes and fragments as fastq.gz files in 0_data
> system(paste("mv ", out.name.P5, " ./0_data/barcodes_", name.out, ".fastq.gz", sep=""))
> system(paste("mv ", out.name.P7, " ./0_data/fragments_", name.out, ".fastq.gz", sep=""))
> 
> # clean up temporary files
> unlink(paste(tempdir(), "/*", sep = ""), recursive = FALSE, force = FALSE)
> 
> print("Total execution time:")
[1] "Total execution time:"
> print(Sys.time()-strt)
Time difference of 5.77975 mins
> devtools::session_info()
─ Session info ───────────────────────────────────────────────────────────────
 setting  value
 version  R version 4.4.1 (2024-06-14)
 os       Rocky Linux 9.4 (Blue Onyx)
 system   x86_64, linux-gnu
 ui       X11
 language (EN)
 collate  en_US.UTF-8
 ctype    en_US.UTF-8
 tz       Europe/Stockholm
 date     2024-09-18
 pandoc   NA (via rmarkdown)

─ Packages ───────────────────────────────────────────────────────────────────
 package              * version date (UTC) lib source
 abind                  1.4-5   2016-07-21 [1] CRAN (R 4.4.1)
 backports              1.5.0   2024-05-23 [1] CRAN (R 4.4.1)
 base64enc              0.1-3   2015-07-28 [2] CRAN (R 4.4.1)
 Biobase              * 2.64.0  2024-04-30 [1] Bioconductor 3.19 (R 4.4.1)
 BiocGenerics         * 0.50.0  2024-04-30 [1] Bioconductor 3.19 (R 4.4.1)
 BiocParallel         * 1.38.0  2024-04-30 [1] Bioconductor 3.19 (R 4.4.1)
 Biostrings           * 2.72.1  2024-06-02 [1] Bioconductor 3.19 (R 4.4.1)
 bitops                 1.0-8   2024-07-29 [1] CRAN (R 4.4.1)
 cachem                 1.1.0   2024-05-16 [2] CRAN (R 4.4.1)
 checkmate              2.3.2   2024-07-29 [1] CRAN (R 4.4.1)
 cli                    3.6.3   2024-06-21 [2] CRAN (R 4.4.1)
 cluster                2.1.6   2023-12-01 [1] CRAN (R 4.4.1)
 codetools              0.2-20  2024-03-31 [1] CRAN (R 4.4.1)
 colorspace             2.1-1   2024-07-26 [1] CRAN (R 4.4.1)
 crayon                 1.5.3   2024-06-20 [2] CRAN (R 4.4.1)
 data.table           * 1.16.0  2024-08-27 [1] CRAN (R 4.4.1)
 DelayedArray           0.30.1  2024-05-07 [1] Bioconductor 3.19 (R 4.4.1)
 deldir                 2.0-4   2024-02-28 [1] CRAN (R 4.4.1)
 devtools             * 2.4.5   2022-10-11 [1] CRAN (R 4.4.1)
 digest                 0.6.37  2024-08-19 [2] CRAN (R 4.4.1)
 doParallel           * 1.0.17  2022-02-07 [1] CRAN (R 4.4.1)
 dplyr                  1.1.4   2023-11-17 [1] CRAN (R 4.4.1)
 ellipsis               0.3.2   2021-04-29 [2] CRAN (R 4.4.1)
 evaluate               0.24.0  2024-06-10 [1] CRAN (R 4.3.1)
 fansi                  1.0.6   2023-12-08 [2] CRAN (R 4.4.1)
 fastmap                1.2.0   2024-05-15 [2] CRAN (R 4.4.1)
 foreach              * 1.5.2   2022-02-02 [1] CRAN (R 4.4.1)
 foreign                0.8-87  2024-06-26 [1] CRAN (R 4.4.1)
 Formula                1.2-5   2023-02-24 [1] CRAN (R 4.4.1)
 fs                     1.6.4   2024-04-25 [2] CRAN (R 4.4.1)
 generics               0.1.3   2022-07-05 [1] CRAN (R 4.4.1)
 GenomeInfoDb         * 1.40.1  2024-05-24 [1] Bioconductor 3.19 (R 4.4.1)
 GenomeInfoDbData       1.2.12  2024-09-05 [1] Bioconductor
 GenomicAlignments    * 1.40.0  2024-04-30 [1] Bioconductor 3.19 (R 4.4.1)
 GenomicRanges        * 1.56.1  2024-06-12 [1] Bioconductor 3.19 (R 4.4.1)
 ggplot2                3.5.1   2024-04-23 [1] CRAN (R 4.4.1)
 glue                   1.7.0   2024-01-09 [2] CRAN (R 4.4.1)
 gridExtra              2.3     2017-09-09 [1] CRAN (R 4.4.1)
 gtable                 0.3.5   2024-04-22 [1] CRAN (R 4.4.1)
 Hmisc                * 5.1-3   2024-05-28 [1] CRAN (R 4.4.1)
 htmlTable              2.4.3   2024-07-21 [1] CRAN (R 4.4.1)
 htmltools              0.5.8.1 2024-04-04 [2] CRAN (R 4.4.1)
 htmlwidgets            1.6.4   2023-12-06 [2] CRAN (R 4.4.1)
 httpuv                 1.6.15  2024-03-26 [2] CRAN (R 4.4.1)
 httr                   1.4.7   2023-08-15 [1] CRAN (R 4.3.1)
 hwriter                1.3.2.1 2022-04-08 [1] CRAN (R 4.4.1)
 interp                 1.1-6   2024-01-26 [1] CRAN (R 4.4.1)
 IRanges              * 2.38.1  2024-07-03 [1] Bioconductor 3.19 (R 4.4.1)
 iterators            * 1.0.14  2022-02-05 [1] CRAN (R 4.4.1)
 jpeg                   0.1-10  2022-11-29 [1] CRAN (R 4.4.1)
 jsonlite               1.8.8   2023-12-04 [1] CRAN (R 4.3.1)
 kableExtra           * 1.4.0   2024-01-24 [1] CRAN (R 4.4.1)
 knitr                  1.48    2024-07-07 [1] CRAN (R 4.3.1)
 later                  1.3.2   2023-12-06 [2] CRAN (R 4.4.1)
 lattice                0.22-6  2024-03-20 [1] CRAN (R 4.4.1)
 latticeExtra           0.6-30  2022-07-04 [1] CRAN (R 4.4.1)
 lifecycle              1.0.4   2023-11-07 [2] CRAN (R 4.4.1)
 magrittr               2.0.3   2022-03-30 [2] CRAN (R 4.4.1)
 Matrix                 1.7-0   2024-04-26 [1] CRAN (R 4.4.1)
 MatrixGenerics       * 1.16.0  2024-04-30 [1] Bioconductor 3.19 (R 4.4.1)
 matrixStats          * 1.4.1   2024-09-08 [1] CRAN (R 4.4.1)
 memoise                2.0.1   2021-11-26 [2] CRAN (R 4.4.1)
 mime                   0.12    2021-09-28 [1] CRAN (R 4.3.1)
 miniUI                 0.1.1.1 2018-05-18 [2] CRAN (R 4.4.1)
 munsell                0.5.1   2024-04-01 [1] CRAN (R 4.4.1)
 nnet                   7.3-19  2023-05-03 [1] CRAN (R 4.4.1)
 pillar                 1.9.0   2023-03-22 [2] CRAN (R 4.4.1)
 pkgbuild               1.4.4   2024-03-17 [2] CRAN (R 4.4.1)
 pkgconfig              2.0.3   2019-09-22 [2] CRAN (R 4.4.1)
 pkgload                1.4.0   2024-06-28 [2] CRAN (R 4.4.1)
 png                    0.1-8   2022-11-29 [1] CRAN (R 4.4.1)
 profvis                0.3.8   2023-05-02 [2] CRAN (R 4.4.1)
 promises               1.3.0   2024-04-05 [2] CRAN (R 4.4.1)
 purrr                  1.0.2   2023-08-10 [2] CRAN (R 4.4.1)
 pwalign                1.0.0   2024-04-30 [1] Bioconductor 3.19 (R 4.4.1)
 R6                     2.5.1   2021-08-19 [1] CRAN (R 4.3.1)
 RColorBrewer           1.1-3   2022-04-03 [1] CRAN (R 4.4.1)
 Rcpp                   1.0.13  2024-07-17 [2] CRAN (R 4.4.1)
 remotes                2.5.0   2024-03-17 [2] CRAN (R 4.4.1)
 rlang                  1.1.4   2024-06-04 [2] CRAN (R 4.4.1)
 rmarkdown              2.28    2024-08-17 [2] CRAN (R 4.4.1)
 rpart                  4.1.23  2023-12-05 [1] CRAN (R 4.4.1)
 Rsamtools            * 2.20.0  2024-04-30 [1] Bioconductor 3.19 (R 4.4.1)
 rstudioapi             0.16.0  2024-03-24 [2] CRAN (R 4.4.1)
 S4Arrays               1.4.1   2024-05-20 [1] Bioconductor 3.19 (R 4.4.1)
 S4Vectors            * 0.42.1  2024-07-03 [1] Bioconductor 3.19 (R 4.4.1)
 scales                 1.3.0   2023-11-28 [1] CRAN (R 4.4.1)
 sessioninfo            1.2.2   2021-12-06 [2] CRAN (R 4.4.1)
 shiny                  1.9.1   2024-08-01 [2] CRAN (R 4.4.1)
 ShortRead            * 1.62.0  2024-04-30 [1] Bioconductor 3.19 (R 4.4.1)
 SparseArray            1.4.8   2024-05-24 [1] Bioconductor 3.19 (R 4.4.1)
 stringi                1.8.4   2024-05-06 [2] CRAN (R 4.4.1)
 stringr                1.5.1   2023-11-14 [2] CRAN (R 4.4.1)
 SummarizedExperiment * 1.34.0  2024-05-01 [1] Bioconductor 3.19 (R 4.4.1)
 svglite                2.1.3   2023-12-08 [1] CRAN (R 4.4.1)
 systemfonts            1.1.0   2024-05-15 [2] CRAN (R 4.4.1)
 tibble                 3.2.1   2023-03-20 [2] CRAN (R 4.4.1)
 tidyselect             1.2.1   2024-03-11 [1] CRAN (R 4.4.1)
 UCSC.utils             1.0.0   2024-04-30 [1] Bioconductor 3.19 (R 4.4.1)
 urlchecker             1.0.1   2021-11-30 [2] CRAN (R 4.4.1)
 usethis              * 3.0.0   2024-07-29 [2] CRAN (R 4.4.1)
 utf8                   1.2.4   2023-10-22 [2] CRAN (R 4.4.1)
 vctrs                  0.6.5   2023-12-01 [2] CRAN (R 4.4.1)
 viridisLite            0.4.2   2023-05-02 [1] CRAN (R 4.4.1)
 xfun                   0.47    2024-08-17 [1] CRAN (R 4.3.1)
 xml2                   1.3.6   2023-12-04 [2] CRAN (R 4.4.1)
 xtable                 1.8-4   2019-04-21 [2] CRAN (R 4.4.1)
 XVector              * 0.44.0  2024-04-30 [1] Bioconductor 3.19 (R 4.4.1)
 zlibbioc               1.50.0  2024-04-30 [1] Bioconductor 3.19 (R 4.4.1)

 [1] /home/jarost/MyRextensions
 [2] /sw/easybuild_milan/software/R/4.4.1-foss-2023a/lib64/R/library

──────────────────────────────────────────────────────────────────────────────
> 
> 
> proc.time()
    user   system  elapsed 
5028.709   65.027  371.157 
